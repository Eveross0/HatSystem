/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */
package hatsystem;

import data.SqlQuery;
import javax.swing.JOptionPane;
import java.util.Arrays;

/**
 *
 * @author luna
 */
public class ChangePsw extends javax.swing.JFrame {

    public String userName;//= LoginMenu.getUsername();
    public String oldPasw;
    public String newPasw;
    public String updatePaswQuery;

    /**
     * Creates new form ChangePsw
     */
    public ChangePsw() {
        initComponents();
        lblError.setVisible(false);
        lblErrorOldPsw.setVisible(false);
    }

    public ChangePsw(String userName) {
        initComponents();
        this.userName = userName;
        lblError.setVisible(false);
        lblErrorOldPsw.setVisible(false);

    }

    /**
     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The content of this method is always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btn_save = new javax.swing.JButton();
        txtOldPsw = new javax.swing.JPasswordField();
        txtNewPsw = new javax.swing.JPasswordField();
        txtConfirmPsw = new javax.swing.JPasswordField();
        lblOldPsw = new javax.swing.JLabel();
        lblNewPsw = new javax.swing.JLabel();
        lblRepNewPsw = new javax.swing.JLabel();
        lblError = new javax.swing.JLabel();
        lblErrorOldPsw = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);

        btn_save.setText("Spara nytt lösenord");
        btn_save.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btn_saveActionPerformed(evt);
            }
        });

        txtOldPsw.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtOldPswActionPerformed(evt);
            }
        });

        lblOldPsw.setText("Nuvarande lösenord");

        lblNewPsw.setText("Nytt lösenord");

        lblRepNewPsw.setText("Upprepa nytt lösenord");

        lblError.setForeground(new java.awt.Color(153, 0, 0));
        lblError.setText("Vänligen fyll i alla fält");

        lblErrorOldPsw.setForeground(new java.awt.Color(153, 0, 0));
        lblErrorOldPsw.setText("Fel lösenord");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(190, 190, 190)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(layout.createSequentialGroup()
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                    .addComponent(lblNewPsw)
                                    .addComponent(lblRepNewPsw))
                                .addGap(18, 18, 18)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                                    .addGroup(layout.createSequentialGroup()
                                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                            .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                                .addComponent(txtConfirmPsw, javax.swing.GroupLayout.PREFERRED_SIZE, 150, javax.swing.GroupLayout.PREFERRED_SIZE)
                                                .addComponent(txtOldPsw, javax.swing.GroupLayout.PREFERRED_SIZE, 150, javax.swing.GroupLayout.PREFERRED_SIZE))
                                            .addComponent(txtNewPsw, javax.swing.GroupLayout.PREFERRED_SIZE, 150, javax.swing.GroupLayout.PREFERRED_SIZE))
                                        .addGap(48, 48, 48)
                                        .addComponent(lblErrorOldPsw, javax.swing.GroupLayout.PREFERRED_SIZE, 102, javax.swing.GroupLayout.PREFERRED_SIZE))
                                    .addComponent(lblError, javax.swing.GroupLayout.PREFERRED_SIZE, 197, javax.swing.GroupLayout.PREFERRED_SIZE)))
                            .addComponent(lblOldPsw)))
                    .addGroup(layout.createSequentialGroup()
                        .addGap(282, 282, 282)
                        .addComponent(btn_save)))
                .addContainerGap(168, Short.MAX_VALUE))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addGap(143, 143, 143)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(lblOldPsw)
                    .addComponent(txtOldPsw, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblErrorOldPsw))
                .addGap(35, 35, 35)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(txtNewPsw, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblNewPsw))
                .addGap(34, 34, 34)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(txtConfirmPsw, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(lblRepNewPsw))
                .addGap(33, 33, 33)
                .addComponent(lblError)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 67, Short.MAX_VALUE)
                .addComponent(btn_save)
                .addGap(44, 44, 44))
        );

        pack();
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void txtOldPswActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtOldPswActionPerformed

    }//GEN-LAST:event_txtOldPswActionPerformed

    private void btn_saveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btn_saveActionPerformed
//        char[] oldPsw = txtOldPsw.getPassword();
//        char[] newPsw = txtNewPsw.getPassword();

        lblError.setVisible(false);
        lblErrorOldPsw.setVisible(false);
        if (txtOldPsw.getPassword().length == 0 || txtNewPsw.getPassword().length == 0
                || txtConfirmPsw.getPassword().length == 0) {

            lblError.setText("Vänligen fyll i alla fält");
            lblError.setVisible(true);

        } else {

            oldPasw = SqlQuery.getValue("SELECT Password FROM employee WHERE Username = '" + userName + "'");
            char[] dbPsw = oldPasw.toCharArray();
            char[] oldPsw = txtOldPsw.getPassword();
            String dbPswString = new String(dbPsw);
            String oldPswString = new String(oldPsw);

            char[] newPsw = txtNewPsw.getPassword();
            char[] confirmPsw = txtConfirmPsw.getPassword();

            if (!dbPswString.equals(oldPswString)) {
                lblErrorOldPsw.setText("Fel lösenord");
                lblErrorOldPsw.setVisible(true);
            } else {

                if (!Arrays.equals(newPsw, confirmPsw)) {
                    lblError.setText("Lösenorden stämmer ej överens");
                    lblError.setVisible(true);

                } else {
                    boolean updated = false;
                    newPasw = new String(newPsw);
                    if (JOptionPane.showConfirmDialog(null, "Är du säker?", "Du ska uppdatera ditt losenord!",
                            JOptionPane.YES_NO_OPTION) == JOptionPane.YES_OPTION) {
                        // yes option
                        updatePaswQuery = "update employee set Password ='" + newPasw + "' where Username ='" + userName + "';";
                        updated = SqlQuery.update(updatePaswQuery);
                    } else {
                        // no option
                    }
                    if (updated) {
                        JOptionPane.showMessageDialog(null, "Lösenordet har uppdaterats!");
                        dispose();

                    } else {
                        JOptionPane.showMessageDialog(null, "Lösenordet har inte ändrats.");
                    }

    }//GEN-LAST:event_btn_saveActionPerformed

            }
            dbPswString = "";
            oldPswString = "";
            dbPsw = null;
            oldPsw = null;
            newPsw = null;
            confirmPsw = null;
        }
        oldPasw = "";
        newPasw = "";

    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btn_save;
    private javax.swing.JLabel lblError;
    private javax.swing.JLabel lblErrorOldPsw;
    private javax.swing.JLabel lblNewPsw;
    private javax.swing.JLabel lblOldPsw;
    private javax.swing.JLabel lblRepNewPsw;
    private javax.swing.JPasswordField txtConfirmPsw;
    private javax.swing.JPasswordField txtNewPsw;
    private javax.swing.JPasswordField txtOldPsw;
    // End of variables declaration//GEN-END:variables
}
