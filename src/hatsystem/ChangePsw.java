/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JFrame.java to edit this template
 */
package hatsystem;

import data.SqlQuery;
import javax.swing.JOptionPane;
import java.util.Arrays;

/**
 *
 * @author luna
 */
public class ChangePsw extends javax.swing.JFrame {

    public String userName;//= LoginMenu.getUsername();
    public String oldPasw;
    public String newPasw;
    public String updatePaswQuery;

    /**
     * Creates new form ChangePsw
     */
    public ChangePsw() {
        initComponents();
        lblError.setVisible(false);
        lblErrorOldPsw.setVisible(false);
    }

    public ChangePsw(String userName) {
        initComponents();
        this.userName = userName;
        lblError.setVisible(false);
        lblErrorOldPsw.setVisible(false);

    }

    /**
     * This method is called from within the constructor to initialize the form. WARNING: Do NOT modify this code. The content of this method is always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        btn_save = new javax.swing.JButton();
        txtOldPsw = new javax.swing.JPasswordField();
        txtNewPsw = new javax.swing.JPasswordField();
        txtConfirmPsw = new javax.swing.JPasswordField();
        lblOldPsw = new javax.swing.JLabel();
        lblNewPsw = new javax.swing.JLabel();
        lblRepNewPsw = new javax.swing.JLabel();
        lblError = new javax.swing.JLabel();
        lblErrorOldPsw = new javax.swing.JLabel();
        jLabel1 = new javax.swing.JLabel();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("TopIT");
        setIconImage(new javax.swing.ImageIcon(getClass().getResource("/Images/TopITcute32px.png")).getImage());
        setResizable(false);

        btn_save.setText("Spara nytt lösenord");
        btn_save.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btn_saveActionPerformed(evt);
            }
        });

        txtOldPsw.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                txtOldPswActionPerformed(evt);
            }
        });

        lblOldPsw.setText("Nuvarande lösenord");

        lblNewPsw.setText("Nytt lösenord");

        lblRepNewPsw.setText("Upprepa nytt lösenord");

        lblError.setForeground(new java.awt.Color(153, 0, 0));
        lblError.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        lblError.setText("Vänligen fyll i alla fält");

        lblErrorOldPsw.setForeground(new java.awt.Color(153, 0, 0));
        lblErrorOldPsw.setText("Fel lösenord");

        jLabel1.setFont(new java.awt.Font("Segoe UI", 1, 24)); // NOI18N
        jLabel1.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel1.setText("Ändra lösenord");

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGap(155, 155, 155)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(125, 125, 125)
                        .addComponent(btn_save))
                    .addComponent(lblError, javax.swing.GroupLayout.PREFERRED_SIZE, 393, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(layout.createSequentialGroup()
                        .addGap(16, 16, 16)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 341, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addGroup(layout.createSequentialGroup()
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                    .addComponent(lblNewPsw)
                                    .addComponent(lblRepNewPsw)
                                    .addComponent(lblOldPsw))
                                .addGap(31, 31, 31)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                                    .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                        .addComponent(txtConfirmPsw, javax.swing.GroupLayout.PREFERRED_SIZE, 150, javax.swing.GroupLayout.PREFERRED_SIZE)
                                        .addComponent(txtOldPsw, javax.swing.GroupLayout.PREFERRED_SIZE, 150, javax.swing.GroupLayout.PREFERRED_SIZE))
                                    .addComponent(txtNewPsw, javax.swing.GroupLayout.PREFERRED_SIZE, 150, javax.swing.GroupLayout.PREFERRED_SIZE))
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 30, Short.MAX_VALUE)
                                .addComponent(lblErrorOldPsw, javax.swing.GroupLayout.PREFERRED_SIZE, 102, javax.swing.GroupLayout.PREFERRED_SIZE)))))
                .addGap(119, 119, 119))
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                .addGap(64, 64, 64)
                .addComponent(jLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 50, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(38, 38, 38)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addComponent(lblOldPsw)
                        .addGap(41, 41, 41)
                        .addComponent(lblNewPsw)
                        .addGap(40, 40, 40)
                        .addComponent(lblRepNewPsw))
                    .addGroup(layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                            .addComponent(txtOldPsw, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                            .addComponent(lblErrorOldPsw))
                        .addGap(35, 35, 35)
                        .addComponent(txtNewPsw, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                        .addGap(34, 34, 34)
                        .addComponent(txtConfirmPsw, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
                .addGap(33, 33, 33)
                .addComponent(lblError)
                .addGap(18, 18, 18)
                .addComponent(btn_save)
                .addContainerGap(84, Short.MAX_VALUE))
        );

        pack();
        setLocationRelativeTo(null);
    }// </editor-fold>//GEN-END:initComponents

    private void txtOldPswActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_txtOldPswActionPerformed

    }//GEN-LAST:event_txtOldPswActionPerformed

    private void btn_saveActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btn_saveActionPerformed
//        char[] oldPsw = txtOldPsw.getPassword();
//        char[] newPsw = txtNewPsw.getPassword();

        lblError.setVisible(false);
        lblErrorOldPsw.setVisible(false);
        if (txtOldPsw.getPassword().length == 0 || txtNewPsw.getPassword().length == 0
                || txtConfirmPsw.getPassword().length == 0) {

            lblError.setText("Vänligen fyll i alla fält");
            lblError.setVisible(true);

        } else {

            String pasword = txtOldPsw.getText();
            String newPasword = txtNewPsw.getText();
            String confirmPasword = txtConfirmPsw.getText();
            
            if (pasword.equals(newPasword) && pasword.equals(confirmPasword)) {
                lblError.setText("Nytt lösenordet är detsamma som nuvarande lösenord");
                lblError.setVisible(true);
            } else {

                char[] newPsw = txtNewPsw.getPassword();
                char[] confirmPsw = txtConfirmPsw.getPassword();
                
                oldPasw = SqlQuery.getValue("SELECT Password FROM employee WHERE Username = '" + userName + "'");
                
                char[] dbPsw = oldPasw.toCharArray();
                char[] oldPsw = txtOldPsw.getPassword();
                String dbPswString = new String(dbPsw);
                String oldPswString = new String(oldPsw);

                if (!dbPswString.equals(oldPswString)) {
                    lblErrorOldPsw.setText("Fel lösenord");
                    lblErrorOldPsw.setVisible(true);
                } else {

                    if (!Arrays.equals(newPsw, confirmPsw)) {
                        lblError.setText("Lösenorden stämmer ej överens");
                        lblError.setVisible(true);

                    } else {
                        boolean updated = false;
                        newPasw = new String(newPsw);
                        if (JOptionPane.showConfirmDialog(null, "Är du säker?", "Du ska uppdatera ditt losenord!",
                                JOptionPane.YES_NO_OPTION) == JOptionPane.YES_OPTION) {
                            // yes option
                            updatePaswQuery = "update employee set Password ='" + newPasw + "' where Username ='" + userName + "';";
                            updated = SqlQuery.update(updatePaswQuery);
                        } else {
                            // no option
                        }
                        if (updated) {
                            JOptionPane.showMessageDialog(null, "Lösenordet har uppdaterats!");
                            dispose();

                        } else {
                            JOptionPane.showMessageDialog(null, "Lösenordet har inte ändrats.");
                        }

    }//GEN-LAST:event_btn_saveActionPerformed

                }
                dbPswString = "";
                oldPswString = "";
                dbPsw = null;
                oldPsw = null;
                newPsw = null;
                confirmPsw = null;
            }

        }
        oldPasw = "";
        newPasw = "";

    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btn_save;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel lblError;
    private javax.swing.JLabel lblErrorOldPsw;
    private javax.swing.JLabel lblNewPsw;
    private javax.swing.JLabel lblOldPsw;
    private javax.swing.JLabel lblRepNewPsw;
    private javax.swing.JPasswordField txtConfirmPsw;
    private javax.swing.JPasswordField txtNewPsw;
    private javax.swing.JPasswordField txtOldPsw;
    // End of variables declaration//GEN-END:variables
}
